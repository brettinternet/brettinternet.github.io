{{ $imagePath := .Destination | safeURL }}
{{ $image := resources.Get (strings.TrimPrefix "/static/" $imagePath) }}

{{ if $image }}
  {{ $isGif := eq (path.Ext $image.RelPermalink) ".gif" }}
  {{ $placeholder := ($image.Resize "48x q20") | images.Filter (images.GaussianBlur 6) }}

  {{ if $isGif }}
    {{/* GIF handling with progressive loading */}}
    {{ $webp_still := $image.Process "webp" }}
    {{ $webp_placeholder := $placeholder.Process "webp" }}

    {{/* Build srcset strings manually */}}
    {{ $gif_srcset := "" }}
    {{ $webp_srcset := "" }}

    {{ range $index, $width := slice 500 800 1200 1500 }}
      {{ if ge $image.Width $width }}
        {{ $gif_resized := $image.Resize (printf "%dx" $width) }}
        {{ $webp_resized := $gif_resized.Process "webp" }}

        {{ if ne $gif_srcset "" }}
          {{ $gif_srcset = printf "%s, %s %dw" $gif_srcset $gif_resized.RelPermalink $gif_resized.Width }}
          {{ $webp_srcset = printf "%s, %s %dw" $webp_srcset $webp_resized.RelPermalink $webp_resized.Width }}
        {{ else }}
          {{ $gif_srcset = printf "%s %dw" $gif_resized.RelPermalink $gif_resized.Width }}
          {{ $webp_srcset = printf "%s %dw" $webp_resized.RelPermalink $webp_resized.Width }}
        {{ end }}
      {{ end }}
    {{ end }}

    {{/* Add original size */}}
    {{ if ne $gif_srcset "" }}
      {{ $gif_srcset = printf "%s, %s %dw" $gif_srcset $image.RelPermalink $image.Width }}
      {{ $webp_srcset = printf "%s, %s %dw" $webp_srcset $webp_still.RelPermalink $webp_still.Width }}
    {{ else }}
      {{ $gif_srcset = printf "%s %dw" $image.RelPermalink $image.Width }}
      {{ $webp_srcset = printf "%s %dw" $webp_still.RelPermalink $webp_still.Width }}
    {{ end }}

    {{ $html := printf `<picture>
      <source
        type="image/webp"
        srcset="%s"
        data-srcset="%s"
        sizes="(max-width: 500px) 100vw, (max-width: 800px) 90vw, (max-width: 1200px) 80vw, 1200px"
      />
      <img
        class="transition-all duration-300 opacity-100 gif-progressive"
        alt="%s"
        src="%s"
        srcset="%s"
        data-webp-src="%s"
        data-webp-srcset="%s"
        data-gif-src="%s"
        data-gif-srcset="%s"
        sizes="(max-width: 500px) 100vw, (max-width: 800px) 90vw, (max-width: 1200px) 80vw, 1200px"
        width="%d"
        height="%d"
        loading="lazy"
        decoding="async"
      />
    </picture>`
      $webp_placeholder.RelPermalink
      $webp_srcset
      .Text
      $placeholder.RelPermalink
      $placeholder.RelPermalink
      $webp_still.RelPermalink
      $webp_srcset
      $image.RelPermalink
      $gif_srcset
      $image.Width
      $image.Height }}
    {{ $html | safeHTML }}

  {{ else }}
    {{/* Non-GIF handling with WebP optimization */}}
    {{ $webp_placeholder := $placeholder.Process "webp" }}
    {{ $original_webp := $image.Process "webp" }}

    {{/* Build srcset strings manually */}}
    {{ $srcset := "" }}
    {{ $webp_srcset := "" }}

    {{ range $index, $width := slice 500 800 1200 1500 }}
      {{ if ge $image.Width $width }}
        {{ $resized := $image.Resize (printf "%dx" $width) }}
        {{ $webp := $resized.Process "webp" }}

        {{ if ne $srcset "" }}
          {{ $srcset = printf "%s, %s %dw" $srcset $resized.RelPermalink $resized.Width }}
          {{ $webp_srcset = printf "%s, %s %dw" $webp_srcset $webp.RelPermalink $webp.Width }}
        {{ else }}
          {{ $srcset = printf "%s %dw" $resized.RelPermalink $resized.Width }}
          {{ $webp_srcset = printf "%s %dw" $webp.RelPermalink $webp.Width }}
        {{ end }}
      {{ end }}
    {{ end }}

    {{/* Add original size */}}
    {{ if ne $srcset "" }}
      {{ $srcset = printf "%s, %s %dw" $srcset $image.RelPermalink $image.Width }}
      {{ $webp_srcset = printf "%s, %s %dw" $webp_srcset $original_webp.RelPermalink $original_webp.Width }}
    {{ else }}
      {{ $srcset = printf "%s %dw" $image.RelPermalink $image.Width }}
      {{ $webp_srcset = printf "%s %dw" $original_webp.RelPermalink $original_webp.Width }}
    {{ end }}

    {{ $html := printf `<picture>
      <source
        type="image/webp"
        srcset="%s"
        data-srcset="%s"
        sizes="(max-width: 500px) 100vw, (max-width: 800px) 90vw, (max-width: 1200px) 80vw, 1200px"
      />
      <img
        class="transition-all duration-200 opacity-100"
        alt="%s"
        src="%s"
        data-src="%s"
        srcset="%s"
        data-srcset="%s"
        sizes="(max-width: 500px) 100vw, (max-width: 800px) 90vw, (max-width: 1200px) 80vw, 1200px"
        width="%d"
        height="%d"
        loading="lazy"
        decoding="async"
      />
    </picture>`
      $webp_placeholder.RelPermalink
      $webp_srcset
      .Text
      $placeholder.RelPermalink
      $image.RelPermalink
      $placeholder.RelPermalink
      $srcset
      $image.Width
      $image.Height }}
    {{ $html | safeHTML }}

  {{ end }}
{{ else }}
  {{/* Fallback for images that cannot be processed */}}
  <img
    src="{{ .Destination | safeURL }}"
    alt="{{ .Text }}"
    loading="lazy"
  />
{{ end }}
