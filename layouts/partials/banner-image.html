{{ $image := index (.Resources.ByType "image") 0 }}

{{ if $image }}
  {{ $image = $image.Resize "600x Lanczos" }}

  {{ $alt := $image.Params.Alt }}
  {{ $caption := $image.Params.Caption }}

  {{ $placeholder := ($image.Resize "48x q20") | images.Filter (images.GaussianBlur 6) }}
  {{ $src_set := (print $image.RelPermalink " " $image.Width "w") }}

  {{ if ge $image.Width "500"}}
  {{ $x_small := $image.Resize "500x" }}
  {{ $src_set = (print $src_set ", "  $x_small.RelPermalink " 500w") }}
  {{ end }}

  {{ if ge $image.Width "800"}}
  {{ $small := $image.Resize "800x" }}
  {{ $src_set = (print $src_set ", " $small.RelPermalink " 800w") }}
  {{ end }}

  {{ if ge $image.Width "1200"}}
  {{ $medium := $image.Resize "1200x" }}
  {{ $src_set = (print $src_set ", " $medium.RelPermalink " 1200w") }}
  {{ end }}

  {{ if gt $image.Width "1500"}}
  {{ $large := $image.Resize "1500x" }}
  {{ $src_set = (print $src_set ", " $large.RelPermalink " 1500w") }}
  {{ end }}

  {{ $image_class := "border border-solid border-slate-400 mx-auto" }}

  <noscript>
    <style>
      figure.lazy {
        display: none;
      }
    </style>
    <figure>
      <img
        class="{{ $image_class }}"
        src="{{ $image.RelPermalink }}"
        width="{{ $image.Width }}"
        height="{{ $image.Height }}"
      />
      {{ with $caption }}
      <figcaption>
        {{ . }}
      </figcaption>
      {{ end }}
    </figure>
  </noscript>

  <figure class="lazy">
    <img
      class="lazyload {{ $image_class }}"
      src="{{ $image.RelPermalink }}"
      alt="{{ $alt }}"
      width="{{ $image.Width }}"
      height="{{ $image.Height }}"
      srcset="data:image/jpeg;base64,{{ $placeholder.Content | base64Encode }}"
      data-src="{{ $image.RelPermalink }}"
      data-sizes="auto"
      data-srcset="{{ $src_set }}"
    />
    {{ with $caption }}
    <figcaption class="text-center">
      {{ . }}
    </figcaption>
    {{ end }}
  </figure>
{{ end }}
